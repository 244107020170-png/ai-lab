<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Project Management | AI Lab</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --glass-outline: rgba(255,255,255,0.06);
    }
    html,body { height:100%; }
    body{
      font-family: 'Poppins', sans-serif;
      margin:0; min-height:100%; color:#EAF6F9;
      background: linear-gradient(180deg,#021821 0%, #04262f 60%, #062a33 100%);
      -webkit-font-smoothing:antialiased;
    }

    .aurora-bg{
      position: fixed; inset: 0; z-index: 0; pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0,180,200,0.06) 0%, transparent 18%),
        radial-gradient(circle at 80% 80%, rgba(10,150,180,0.06) 0%, transparent 22%),
        url("/mnt/data/8da448e6-1bc3-43b7-a134-7c04a6886a78.png");
      background-size: cover; background-position: center top; mix-blend-mode: overlay;
      filter: blur(6px) saturate(120%); opacity: .9; animation: aurora-move 14s linear infinite alternate;
    }
    @keyframes aurora-move { 0%{transform:translateY(0)}100%{transform:translateY(-12px) scale(1.02)} }

    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-outline);
      backdrop-filter: blur(8px) saturate(120%);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }

    .admin-nav { position: fixed; top: 18px; left:50%; transform:translateX(-50%);
      width: calc(100% - 120px); max-width:1150px; z-index:30; padding:10px 18px; }
    .nav-pill { border-radius:999px; padding:10px 18px; display:inline-flex; align-items:center; gap:10px; backdrop-filter:blur(10px); }
    .nav-active { position:relative; color:white !important; font-weight:500;}
    .nav-active::before { content:""; position:absolute; inset:0; border-radius:999px;
      background: linear-gradient(to bottom right, rgba(0,220,255,0.6), rgba(0,120,150,0.6));
      backdrop-filter: blur(10px); z-index:-1; box-shadow:0 0 30px rgba(0,200,255,0.3); }

    .fade-up { opacity:0; transform: translateY(22px); transition: all .5s cubic-bezier(.2,.9,.2,1); }
    .fade-up.show { opacity:1; transform: translateY(0); }

    .table-row + .divider { height:1px; background: rgba(255,255,255,0.06); margin: 10px 0; border-radius: 2px; }

    .status-dot { width:10px; height:10px; border-radius:999px; display:inline-block; box-shadow: 0 0 10px rgba(0,0,0,0.6); }

    /* small menu popup inside more button */
    .more-btn { position: relative; display:inline-block; }
    .menu-popup { position:absolute; right:0; top:26px; background:rgba(0,0,0,.78); border-radius:8px; padding:6px; min-width:120px; box-shadow:0 8px 30px rgba(0,0,0,0.6); z-index:60; }
    .menu-popup button { display:block; width:100%; text-align:left; padding:8px 10px; border-radius:6px; background:transparent; color:white; border:none; cursor:pointer; }
    .menu-popup button:hover { background: rgba(255,255,255,0.04); }

    @media (max-width:980px){
      .admin-nav { width: calc(100% - 40px); left:20px; transform:none; }
      main { padding-left:20px; padding-right:20px; }
      .table-row { grid-template-columns: 80px 1fr 100px 40px; }
    }
  </style>
</head>
<body>

  <div class="aurora-bg" aria-hidden="true"></div>

  <!-- NAV -->
  <header class="admin-nav">
    <div class="glass nav-pill justify-between items-center w-full px-6 flex">
      <div class="flex items-center gap-4">
        <img src="img/logo.png" alt="logo" class="w-36 h-auto object-contain">
        <div class="text-slate-100 text-lg font-semibold">Lab Admin Page</div>
      </div>

      <nav class="flex items-center gap-3">
        <a href="/admin" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">Home</a>
        <a href="/admin/members" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">Members</a>
        <a href="/admin/projects" class="px-5 py-2 rounded-full nav-active">Projects</a>
        <a href="/admin/news" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">News</a>
      </nav>
    </div>
  </header>

  <main class="pt-36 pb-20 max-w-7xl mx-auto relative z-10 px-8">

    <section class="mb-6 fade-up" id="heroText">
      <h1 class="text-4xl font-bold text-white">Project Management</h1>
      <p class="mt-3 text-slate-300 max-w-3xl">Manage the projects shown on the website. Edit participants, update status, attach documents.</p>
    </section>

    <!-- Controls -->
    <section class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
      <div class="col-span-2 flex gap-3">
        <div id="searchWrap" class="flex items-center gap-3 bg-black/30 glass rounded-xl px-4 py-3 w-full">
          <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
          <input id="searchInput" type="text" placeholder="Search projects..." class="bg-transparent outline-none w-full text-slate-200" />
        </div>

        <div class="w-48 flex items-center bg-black/30 glass px-4 py-3 rounded-xl justify-between">
          <div class="text-slate-200">Filter</div>
          <select id="filterSelect" class="bg-transparent outline-none text-slate-200">
            <option value="all">All</option>
            <option value="published">Published</option>
            <option value="progress">Work in Progress</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
      </div>

      <div class="flex justify-end">
        <button id="addBtn" class="bg-transparent border border-white/10 hover:bg-cyan-600/10 text-white px-4 py-2 rounded-md glass">+ Add Project</button>
      </div>
    </section>

    <!-- Projects list -->
    <section id="listCard" class="glass rounded-2xl p-6 fade-up float-slow">
      <div class="flex items-center justify-between mb-4 px-4">
        <div class="text-white text-lg font-semibold">Projects List</div>
        <div class="text-sm text-slate-300">Showing <span id="countShown">0</span> projects</div>
      </div>

      <!-- header for desktop -->
      <div class="hidden md:flex items-center px-6 pb-2 text-slate-300 text-sm">
        <div class="w-32">ID</div>
        <div class="w-[52%]">Title</div>
        <div class="w-36">Status</div>
        <div class="w-12 text-center">•••</div>
      </div>

      <!-- container that will be filled by JS -->
      <div id="projectsContainer" class="flex flex-col gap-2 mt-2 px-2"></div>

      <!-- pagination (client-side) -->
      <div id="pagination" class="mt-6 flex items-center justify-center gap-3"></div>
    </section>

    <footer class="mt-12 flex justify-between items-center text-slate-200">
      <div class="text-lg">© 2025 AI Lab Polinema</div>
      <div>Contact: <a href="mailto:ailab@polinema.ac.id" class="underline">ailab@polinema.ac.id</a></div>
    </footer>
  </main>

  <script>
  const API_BASE = "http://127.0.0.1:8000";
  const API_ENDPOINT = API_BASE + "/api/activities";
  const rowsPerPage = 5;

  let projects = [];
  let currentPage = 1;

  const statusColors = { 
    published: "#22c55e",
    progress: "#f59e0b",
    cancelled: "#ef4444"
  };

  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  document.addEventListener("DOMContentLoaded", () => {

    console.log("DOM ready → loading projects…");

    // Wire events
    qs('#searchInput').addEventListener('input', () => {
      currentPage = 1;
      renderList();
      renderPagination();
    });

    qs('#filterSelect').addEventListener('change', () => {
      currentPage = 1;
      renderList();
      renderPagination();
    });

    qs('#addBtn').addEventListener('click', () => {
      window.location.href = "/admin/projects/create.html";
    });

    // Load data
    loadProjects();
  });

  async function loadProjects() {
    try {
      const res = await fetch(API_ENDPOINT);
      if (!res.ok) throw new Error("API returned " + res.status);

      projects = await res.json();
      console.log("Loaded projects:", projects);

    } catch (err) {
      console.error("Failed to fetch projects:", err);
      projects = [];
    }

    renderList();
    renderPagination();
  }


  function applyFilters(items) {
    const q = qs('#searchInput').value.toLowerCase().trim();
    const f = qs('#filterSelect').value;

    return items.filter(p => {
      const matchQ =
        !q ||
        (p.title || "").toLowerCase().includes(q) ||
        (p.code || "").toLowerCase().includes(q);

      const matchF = f === "all" || p.status === f;

      return matchQ && matchF;
    });
  }


  function renderList() {
    const container = qs('#projectsContainer');
    container.innerHTML = "";

    const filtered = applyFilters(projects);
    qs('#countShown').textContent = filtered.length;

    const start = (currentPage - 1) * rowsPerPage;
    const pageItems = filtered.slice(start, start + rowsPerPage);

    if (pageItems.length === 0) {
      container.innerHTML = `<div class="p-6 text-center text-slate-300">No projects found.</div>`;
      return;
    }

    pageItems.forEach(p => {
      const row = document.createElement("div");
      row.className =
        "table-row grid grid-cols-[8rem_1fr_12rem_3rem] items-center px-6 py-4 rounded-xl bg-white/5 hover:bg-white/10 transition";

      row.innerHTML = `
        <div class="font-medium">${escapeHtml(p.id)}</div>
        <div>${escapeHtml(p.title)}</div>
        <div class="flex items-center gap-2">
          <span class="status-dot" style="background:${statusColors[p.status]}"></span>
          <span>${escapeHtml(p.status)}</span>
        </div>
        <div class="text-center text-white/60">
          <div class="more-btn inline-block cursor-pointer">⋯
            <div class="menu-popup hidden">
              <button onclick="onEdit(${p.id})">Edit</button>
              <button onclick="onDelete(${p.id})" style="color:#ff8a8a">Delete</button>
            </div>
          </div>
        </div>
      `;

      container.appendChild(row);
    });

    initMenus();
  }


  function renderPagination() {
    const pag = qs('#pagination');
    pag.innerHTML = "";

    const filtered = applyFilters(projects);
    const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;

    const prev = document.createElement("button");
    prev.textContent = "<";
    prev.disabled = currentPage === 1;
    prev.className = "p-2 bg-white/5 rounded-xl";
    prev.onclick = () => {
      currentPage--;
      renderList();
      renderPagination();
    };
    pag.appendChild(prev);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className =
        "px-3 py-1 rounded-md " +
        (i === currentPage
          ? "bg-gradient-to-r from-cyan-400 to-teal-400 text-black font-semibold"
          : "bg-white/5 text-white/80");

      btn.onclick = () => {
        currentPage = i;
        renderList();
        renderPagination();
      };

      pag.appendChild(btn);
    }

    const next = document.createElement("button");
    next.textContent = ">";
    next.disabled = currentPage >= totalPages;
    next.className = "p-2 bg-white/5 rounded-xl";
    next.onclick = () => {
      currentPage++;
      renderList();
      renderPagination();
    };
    pag.appendChild(next);
  }


  window.onEdit = id => {
    window.location.href = `/admin/projects/edit.html?id=${id}`;
  };

  window.onDelete = async id => {
    if (!confirm("Delete this project?")) return;

    await fetch(`${API_ENDPOINT}/${id}`, { method: "DELETE" });
    loadProjects();
  };


  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }
</script>

</body>
</html>