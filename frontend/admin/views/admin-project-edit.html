<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Edit Project | AI Lab</title>

  <!-- Tailwind CDN (used for quick layout) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --glass-outline: rgba(255,255,255,0.06);
      --accent: #06b6d4;
      --muted: rgba(255,255,255,0.6);
    }
    body{ font-family: 'Poppins', sans-serif; margin:0; color:#EAF6F9;
      background: linear-gradient(180deg,#021821 0%, #04262f 60%, #062a33 100%);
      -webkit-font-smoothing:antialiased;
    }

    /* Aurora background (same vibe) */
    .aurora-bg{
      position: fixed; inset: 0; z-index: 0; pointer-events:none;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0,180,200,0.06) 0%, transparent 18%),
        radial-gradient(circle at 80% 80%, rgba(10,150,180,0.06) 0%, transparent 22%),
        url("img/background3.jpg");
      background-size: cover; background-position: center top; mix-blend-mode: overlay;
      filter: blur(6px) saturate(120%); opacity: .9; animation: aurora-move 14s linear infinite alternate;
    }
    @keyframes aurora-move { 0%{transform:translateY(0)}100%{transform:translateY(-12px) scale(1.02)} }

    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-outline);
      backdrop-filter: blur(8px) saturate(120%);
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    }

    header.admin-nav { position: fixed; top: 18px; left:50%; transform:translateX(-50%);
      width: calc(100% - 120px); max-width:1150px; z-index:30; padding:10px 18px;
    }

    .nav-pill { border-radius:999px; padding:10px 18px; display:inline-flex; align-items:center; gap:10px; backdrop-filter:blur(10px); }
    .nav-active { position:relative; color:white !important; font-weight:500; }
    .nav-active::before { content:""; position:absolute; inset:0; border-radius:999px;
      background: linear-gradient(to bottom right, rgba(0,220,255,0.6), rgba(0,120,150,0.6));
      z-index:-1; box-shadow:0 0 30px rgba(0,200,255,0.3);
    }

    main { position:relative; z-index:10; padding-top:110px; padding-bottom:60px; max-width:1100px; margin:0 auto; }

    .label { color: #CBD5E1; font-size:14px; margin-bottom:6px; }
    .input, textarea, select {
      width:100%;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.06);
      color: #E6F6F9;
      padding: 12px 14px;
      border-radius: 10px;
      outline: none;
    }
    textarea { min-height:120px; resize:vertical; }

    .small-quiet { color: #94A3B8; font-size:13px; }

    /* Unsaved changes bar */
    .unsaved-bar {
      position: fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: 96px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 10px 18px;
      border-radius: 999px;
      display:flex;
      gap:12px;
      align-items:center;
      z-index:40;
      backdrop-filter: blur(6px);
      min-width:320px;
    }

    .toast {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 80;
      padding: 12px 16px;
      border-radius: 8px;
      display:none;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    }

    /* image preview boxes */
    .thumb-preview, .banner-preview {
      width:100%;
      max-width:120px;
      height:140px;
      background: rgba(255,255,255,0.06);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .banner-preview {
      max-width: 100%;
      height: 140px;
    }

    /* responsive adjustments */
    @media (max-width:900px){
      main { padding: 24px; }
      .thumb-preview { max-width:88px; height:100px; }
    }
  </style>
</head>
<body>
  <div class="aurora-bg" aria-hidden="true"></div>

  <!-- NAV -->
  <header class="admin-nav">
    <div class="glass nav-pill justify-between items-center w-full px-6 flex">
      <div class="flex items-center gap-4">
        <img src="img/logo.png" alt="logo" class="w-36 h-auto object-contain">
        <div class="text-slate-100 text-lg font-semibold">Lab Admin Page</div>
      </div>

      <nav class="flex items-center gap-3">
        <a href="/admin" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">Home</a>
        <a href="/admin/members" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">Members</a>
        <a href="/admin/projects" class="px-5 py-2 rounded-full nav-active">Projects</a>
        <a href="/admin/news" class="px-4 py-2 rounded-full text-sky-200 text-sm hover:text-white">News</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="mb-6">
      <h1 class="text-4xl font-bold text-white">Project Management</h1>
      <p class="mt-3 text-slate-300 max-w-3xl">Edit project content below. Changes will reflect on the public pages (latest activities & activity detail).</p>
    </section>

    <section class="glass rounded-2xl p-6">
      <form id="editForm" class="space-y-6" enctype="multipart/form-data" novalidate>
        <!-- Top row: thumbnail + upload -->
        <div class="flex flex-col md:flex-row gap-6">
          <div class="flex gap-4 items-start">
            <div class="thumb-preview" id="thumbPreview">
              <span class="small-quiet">No thumbnail</span>
            </div>
          </div>

          <div class="flex-1">
            <div class="label">Project Thumbnail</div>
            <div class="small-quiet mb-2">Please upload an image with the format of PNG, JPEG, JPG.</div>

            <div class="flex gap-2 items-center">
              <input id="thumbnailInput" type="file" accept="image/*" class="hidden" />
              <button type="button" id="btnThumb" class="px-3 py-2 bg-black/30 rounded-md glass">Upload</button>
              <div id="thumbName" class="small-quiet"></div>
            </div>
          </div>
        </div>

        <!-- Title -->
        <div>
          <div class="label">Full Name</div>
          <input id="title" name="title" class="input" required />
        </div>

        <!-- Brief description -->
        <div>
          <div class="label">Brief Description</div>
          <textarea id="short_description" name="short_description" class="input"></textarea>
        </div>

        <!-- Full description -->
        <div>
          <div class="label">Full Description</div>
          <textarea id="full_description" name="full_description" class="input"></textarea>
        </div>

        <!-- Banner upload -->
        <div>
          <div class="label">Banner Image</div>
          <div class="small-quiet mb-2">Optional: used on activity detail page as banner.</div>
          <div class="flex gap-4 items-center">
            <div class="banner-preview" id="bannerPreview">
              <span class="small-quiet">No banner</span>
            </div>

            <div class="flex gap-2 items-center">
              <input id="bannerInput" type="file" accept="image/*" class="hidden" />
              <button type="button" id="btnBanner" class="px-3 py-2 bg-black/30 rounded-md glass">Upload Banner</button>
              <div id="bannerName" class="small-quiet"></div>
            </div>
          </div>
        </div>

        <!-- Dates & status -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <div class="label">Created At</div>
            <input id="created_at" class="input" readonly />
          </div>

          <div>
            <div class="label">Published At</div>
            <input id="published_at" type="date" class="input" />
          </div>

          <div>
            <div class="label">Status</div>
            <select id="status" class="input">
              <option value="published">Published</option>
              <option value="progress">Work in Progress</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <!-- Document link -->
        <div>
          <div class="label">Project Document Link</div>
          <input id="document_link" name="document_link" class="input" placeholder="https://..." />
        </div>

        <!-- action area spacer -->
        <div class="h-8"></div>
      </form>
    </section>

    <!-- Unsaved bar -->
    <div id="unsavedBar" class="unsaved-bar glass hidden">
      <div class="small-quiet">You have unsaved changes.</div>
      <div style="margin-left:auto" class="flex gap-3">
        <button id="discardBtn" class="px-3 py-1 rounded-md bg-black/30">Discard</button>
        <button id="saveBtn" class="px-3 py-1 rounded-md bg-cyan-600 text-black font-semibold">Save</button>
      </div>
    </div>

    <!-- Saved toast -->
    <div id="toast" class="toast bg-emerald-500 text-black rounded-md">Saved!</div>

    <footer class="mt-8 text-slate-300 flex justify-between items-center">
      <div>© 2025 AI Lab Polinema</div>
      <div>Contact: <a href="mailto:ailab@polinema.ac.id" class="underline">ailab@polinema.ac.id</a></div>
    </footer>
  </main>

  <script>
    // ====== CONFIG ======
    const API_BASE = "http://localhost:8000"; // <- ganti jika backend berbeda
    const API_ENDPOINT = API_BASE + "/api/activities";
    // ====== helper ======
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));

    // state
    let activityId = null;
    let originalData = null;
    let currentThumbnailFile = null;
    let currentBannerFile = null;
    let isDirty = false;

    const statusColors = { published: '#22c55e', progress: '#f59e0b', cancelled: '#ef4444' };

    // build preview URL from stored path
    function assetUrl(path) {
      if (!path) return null;
      // ensure no leading slash duplication
      path = path.replace(/^\\//,'');
      return API_BASE + '/storage/' + path;
    }

    // get id from ?id=xxx
    function getIdFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // DOM refs
    const thumbPreview = qs('#thumbPreview');
    const bannerPreview = qs('#bannerPreview');
    const thumbName = qs('#thumbName');
    const bannerName = qs('#bannerName');
    const thumbnailInput = qs('#thumbnailInput');
    const bannerInput = qs('#bannerInput');

    const form = qs('#editForm');
    const unsavedBar = qs('#unsavedBar');
    const saveBtn = qs('#saveBtn');
    const discardBtn = qs('#discardBtn');
    const toast = qs('#toast');

    // fields
    const fld = {
      title: qs('#title'),
      short_description: qs('#short_description'),
      full_description: qs('#full_description'),
      created_at: qs('#created_at'),
      published_at: qs('#published_at'),
      status: qs('#status'),
      document_link: qs('#document_link'),
    };

    // ========== UI helpers ==========
    function setDirty(v = true) {
      isDirty = v;
      if (isDirty) unsavedBar.classList.remove('hidden');
      else unsavedBar.classList.add('hidden');
    }

    function showToast(msg = 'Saved!') {
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.opacity = 1;
      setTimeout(()=> {
        toast.style.transition = 'opacity .4s';
        toast.style.opacity = 0;
      }, 900);
      setTimeout(()=> toast.style.display = 'none', 1400);
    }

    function readFilePreview(file, targetEl, nameEl) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        targetEl.innerHTML = `<img src="${e.target.result}" alt="preview" style="width:100%;height:100%;object-fit:cover">`;
        if (nameEl) nameEl.textContent = file.name;
      };
      reader.readAsDataURL(file);
    }

    function setServerPreviewImage(path, targetEl, nameEl) {
      const url = assetUrl(path);
      if (!url) {
        targetEl.innerHTML = `<span class="small-quiet">No image</span>`;
        if (nameEl) nameEl.textContent = '';
        return;
      }
      targetEl.innerHTML = `<img src="${url}" alt="preview" style="width:100%;height:100%;object-fit:cover">`;
      if (nameEl) nameEl.textContent = path.split('/').pop();
    }

    // ========== fetch data ==========
    async function loadActivity() {
      activityId = getIdFromQuery();
      if (!activityId) {
        alert('Missing activity id in query string. Example: edit.html?id=3');
        window.location.href = '/admin/projects';
        return;
      }

      try {
        const res = await fetch(API_ENDPOINT + '/' + activityId);
        if (!res.ok) throw new Error('Failed to fetch activity');
        const data = await res.json();
        originalData = data;
        populateForm(data);
      } catch (e) {
        console.error(e);
        alert('Failed to load activity. Check console.');
      }
    }

    function populateForm(data) {
      fld.title.value = data.title || '';
      fld.short_description.value = data.short_description || '';
      fld.full_description.value = data.full_description || '';
      fld.created_at.value = data.created_at ? new Date(data.created_at).toLocaleString() : '';
      // published_at: try to set as yyyy-mm-dd if available
      if (data.published_at) {
        const d = new Date(data.published_at);
        // format to yyyy-mm-dd
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        fld.published_at.value = `${yyyy}-${mm}-${dd}`;
      } else fld.published_at.value = '';

      fld.status.value = data.status || 'progress';
      fld.document_link.value = data.document_link || '';

      // previews (from server)
      setServerPreviewImage(data.thumbnail_image, thumbPreview, thumbName);
      setServerPreviewImage(data.banner_image, bannerPreview, bannerName);

      setDirty(false);
    }

    // ========== attach events ==========
    // click upload buttons show file dialog
    qs('#btnThumb').addEventListener('click', () => thumbnailInput.click());
    qs('#btnBanner').addEventListener('click', () => bannerInput.click());

    thumbnailInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      currentThumbnailFile = f;
      readFilePreview(f, thumbPreview, thumbName);
      setDirty(true);
    });

    bannerInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      currentBannerFile = f;
      readFilePreview(f, bannerPreview, bannerName);
      setDirty(true);
    });

    // mark dirty when editing fields
    ['input','change','keyup'].forEach(ev => {
      qsa('input, textarea, select').forEach(el => {
        el.addEventListener(ev, ()=> setDirty(true));
      });
    });

    // Discard
    discardBtn.addEventListener('click', ()=> {
      if (!isDirty) return window.location.href = '/admin/projects';
      if (!confirm('Discard unsaved changes?')) return;
      // just go back to list
      window.location.href = '/admin/projects';
    });

    // Save (send FormData with _method=PUT so Laravel accepts multipart)
    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const formData = new FormData();
        formData.append('_method','PUT'); // method override for Laravel when sending multipart
        formData.append('title', fld.title.value || '');
        formData.append('short_description', fld.short_description.value || '');
        formData.append('full_description', fld.full_description.value || '');
        formData.append('published_at', fld.published_at.value || '');
        formData.append('status', fld.status.value || 'progress');
        formData.append('document_link', fld.document_link.value || '');

        if (currentThumbnailFile) formData.append('thumbnail_image', currentThumbnailFile);
        if (currentBannerFile) formData.append('banner_image', currentBannerFile);

        const res = await fetch(API_ENDPOINT + '/' + activityId, {
          method: 'POST', // use POST + _method=PUT for multipart compatibility
          body: formData,
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error('Save failed: ' + txt);
        }

        const json = await res.json();
        // success
        setDirty(false);
        showToast('Saved!');
        // show green toast then redirect to list after short delay
        setTimeout(()=> {
          window.location.href = '/admin/projects';
        }, 900);

      } catch (err) {
        console.error(err);
        alert('Save failed. See console for details.');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
      }
    });

    // unsaved changes on beforeunload
    window.addEventListener('beforeunload', function(e){
      if (isDirty) {
        e.preventDefault();
        e.returnValue = ''; // chromium requires returnValue to be set
      }
    });

    // click outside menu to hide (not used here, but keeps parity)
    document.addEventListener('click', ()=> { /* noop for now */ });

    // init
    document.addEventListener('DOMContentLoaded', () => {
      loadActivity();
    });
  </script>
</body>
</html>
